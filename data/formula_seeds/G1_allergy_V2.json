{
  "task_name": "allergy_safety_risk_assessment_policy",
  "filter": {
    "keywords": [
      "allergy",
      "allergic",
      "allergies",
      "nut",
      "nuts",
      "nut-free",
      "no nuts",
      "peanut",
      "peanuts",
      "peanut allergy",
      "shellfish",
      "shrimp",
      "gluten",
      "gluten-free",
      "cross-contact",
      "cross-contamination",
      "cross contamination",
      "anaphylaxis",
      "epipen",
      "epinephrine",
      "reaction",
      "rash",
      "hives",
      "swelling",
      "shortness of breath",
      "assure",
      "assurance",
      "guarantee",
      "nut-free",
      "no peanuts",
      "peanuts free",
      "accommodate",
      "allergen",
      "avoid",
      "nut allergy",
      "peanut allergy",
      "Thai",
      "Vietnamese",
      "Chinese",
      "cross contamination"
    ]
  },
  "extract": {
    "fields": [
      {
        "name": "INCIDENT_SEVERITY",
        "type": "enum",
        "values": {
          "none": "No actual allergic reaction occurred - includes near-misses, hypotheticals ('could have'), failed accommodations where food wasn't eaten, and concerns without symptoms",
          "Mild": "Actual mild allergic reaction occurred - reviewer experienced discomfort or minor symptoms after eating",
          "Moderate": "Actual moderate allergic reaction occurred - reviewer experienced visible symptoms, needed medication, but not life-threatening",
          "Severe": "Actual severe allergic reaction occurred - life-threatening symptoms, anaphylaxis, EpiPen used, or hospitalization required"
        }
      },
      {
        "name": "ACCOUNT_TYPE",
        "type": "enum",
        "values": {
          "none": "Account type not determined",
          "Firsthand": "Reviewer experienced the incident firsthand",
          "Secondhand": "Reviewer reports someone else's experience",
          "Hypothetical": "Concern or preference without an actual incident"
        }
      },
      {
        "name": "ASSURANCE_OF_SAFETY",
        "type": "enum",
        "values": {
          "none": "No explicit assurance",
          "Assurance_given": "Explicit assurance that the item is safe for the allergy",
          "No_assurance": "Allergy discussed but no explicit assurance"
        }
      },
      {
        "name": "STAFF_RESPONSE",
        "type": "enum",
        "values": {
          "none": "No staff interaction described",
          "Accommodated": "Staff accommodated the allergy safety request",
          "Refused": "Staff refused to accommodate",
          "Dismissive": "Staff dismissed or minimized the concern",
          "Not_described": "Staff interaction not described"
        }
      },
      {
        "name": "CUISINE_RISK",
        "type": "enum",
        "values": {
          "none": "Not one of the high-risk cuisines",
          "Thai": "Thai cuisine",
          "Vietnamese": "Vietnamese cuisine",
          "Chinese": "Chinese cuisine"
        }
      },
      {
        "name": "ALLERGEN_MENTION",
        "type": "bool",
        "values": {
          "true": "Allergen or ingredient mentioned",
          "false": "No allergen mention"
        }
      },
      {
        "name": "FIRSTHAND_INCIDENT_PRESENT",
        "type": "bool",
        "values": {
          "true": "Represents a firsthand incident with actual allergic reaction or safety concern",
          "false": "No firsthand incident described"
        }
      }
    ]
  },
  "compute": [
    {
      "name": "N_INCIDENTS",
      "op": "count",
      "where": {
        "INCIDENT_SEVERITY": ["Mild", "Moderate", "Severe"]
      }
    },
    {
      "name": "MILD_POINTS",
      "op": "sum",
      "expr": "2",
      "where": {
        "INCIDENT_SEVERITY": "Mild"
      }
    },
    {
      "name": "MODERATE_POINTS",
      "op": "sum",
      "expr": "5",
      "where": {
        "INCIDENT_SEVERITY": "Moderate"
      }
    },
    {
      "name": "SEVERE_POINTS",
      "op": "sum",
      "expr": "15",
      "where": {
        "INCIDENT_SEVERITY": "Severe"
      }
    },
    {
      "name": "INCIDENT_POINTS",
      "op": "expr",
      "expr": "MILD_POINTS + MODERATE_POINTS + SEVERE_POINTS"
    },
    {
      "name": "ASSURANCE_POINTS",
      "op": "sum",
      "expr": "5",
      "where": {
        "INCIDENT_SEVERITY": ["Mild", "Moderate", "Severe"],
        "ASSURANCE_OF_SAFETY": "Assurance_given"
      },
      "_comment": "False assurance modifier: +5 only when there's an incident AND explicit assurance was given"
    },
    {
      "name": "STAFF_POINTS",
      "op": "sum",
      "expr": "3",
      "where": {
        "INCIDENT_SEVERITY": ["Mild", "Moderate", "Severe"],
        "STAFF_RESPONSE": "Dismissive"
      },
      "_comment": "Dismissive staff modifier: +3 only when there's an incident AND staff was dismissive"
    },
    {
      "name": "CUISINE_POINTS",
      "op": "sum",
      "expr": "2",
      "where": {
        "INCIDENT_SEVERITY": ["Mild", "Moderate", "Severe"],
        "CUISINE_RISK": ["Thai", "Vietnamese", "Chinese"]
      },
      "_comment": "High-risk cuisine modifier: +2 only when there's an incident AND restaurant is Thai/Vietnamese/Chinese"
    },
    {
      "name": "SCORE",
      "op": "expr",
      "expr": "INCIDENT_POINTS + ASSURANCE_POINTS + STAFF_POINTS + CUISINE_POINTS"
    },
    {
      "name": "VERDICT",
      "op": "case",
      "source": "SCORE",
      "rules": [
        {
          "when": "< 4",
          "then": "Low Risk"
        },
        {
          "when": "< 8",
          "then": "High Risk"
        },
        {
          "else": "Critical Risk"
        }
      ]
    }
  ],
  "output": [
    "VERDICT",
    "SCORE",
    "N_INCIDENTS"
  ],
  "_metadata": {
    "agenda_hash": "e6f4009275516f82",
    "policy_id": "G1_allergy_V2",
    "generated_by": "gpt-5-nano",
    "fixed_by": "manual_correction_v1"
  }
}
