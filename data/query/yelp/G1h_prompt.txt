============================================================
Agenda
============================================================

Help assess how well this restaurant accommodates dietary restrictions.

Analyze each review to identify mentions of dietary restrictions or preferences.
For each record, extract the L0 primitives defined below.

This task combines complex formula (credibility weighting, interactions)
with L1.5 diet type grouping for pattern detection.

============================================================
L0: Primitives (per-review extraction)
============================================================

DIET_TYPE
- vegetarian: no meat (may include dairy/eggs)
- vegan: no animal products
- gluten_free: celiac or gluten sensitivity
- other: kosher, halal, keto, dairy-free, low-sodium, etc.

ACCOMMODATION_OUTCOME
- success: restaurant successfully accommodated the dietary need
- failure: restaurant failed to accommodate (wrong dish, contamination, no options)
- partial: some options available but limited or inconvenient
- not_attempted: no accommodation was requested or tested

ACCOUNT_TYPE
- firsthand: direct personal experience (I ordered, we asked, my partner is...)
- secondhand: reported (my friend said..., I heard...)
- hypothetical: general observation without personal experience

STAFF_KNOWLEDGE
- knowledgeable: staff understood the diet and could answer questions
- uncertain: staff was unsure or had to check
- uninformed: staff didn't understand the dietary restriction
- none: no staff interaction about diet described

MENU_CLARITY
- clear: menu clearly labels dietary options
- partial: some labeling but incomplete
- unclear: no dietary labeling on menu
- unknown: not mentioned

CONSEQUENCE_SEVERITY
- none: no negative consequence
- inconvenience: had to modify order, wait, or settle for limited options
- health_impact: got sick, allergic reaction, or felt unwell
- serious: required medical attention

============================================================
L1: Composites (derived per review) - COMPLEX
============================================================

Credibility Weight (based on ACCOUNT_TYPE):
  firsthand = 1.0
  secondhand = 0.5
  hypothetical = 0.1

Outcome Score:
  success = +3
  partial = +1
  failure = -3
  not_attempted = 0

Staff Modifier:
  knowledgeable = +1.5
  uncertain = 0
  uninformed = -1.5
  none = 0

Menu Modifier:
  clear = +1.0
  partial = 0
  unclear = -0.5
  unknown = 0

Consequence Penalty:
  none = 0
  inconvenience = -1.0
  health_impact = -4.0
  serious = -8.0

L1_REVIEW_SCORE = (OUTCOME_SCORE * CREDIBILITY_WEIGHT) + STAFF_MODIFIER + MENU_MODIFIER + CONSEQUENCE_PENALTY

UNINFORMED_FAILURE (interaction effect):
  If STAFF_KNOWLEDGE = uninformed AND ACCOMMODATION_OUTCOME = failure: -2.0
  Else: 0

HEALTH_INCIDENT = true iff:
  - CONSEQUENCE_SEVERITY in {health_impact, serious}
  - ACCOUNT_TYPE = firsthand
Else HEALTH_INCIDENT = false

L1_TOTAL_SCORE = L1_REVIEW_SCORE + UNINFORMED_FAILURE

============================================================
L1.5: Diet Type Grouping
============================================================

Group reviews by DIET_TYPE:
  VEGETARIAN = mentions vegetarian, no meat, pescatarian
  VEGAN = mentions vegan, plant-based, no animal products
  GLUTEN_FREE = mentions gluten-free, celiac, gluten intolerance
  OTHER = other dietary restrictions (kosher, halal, keto, etc.)

For each diet bucket, compute:
  BUCKET_N_REVIEWS = count of reviews mentioning this diet
  BUCKET_SUM_SCORE = sum of L1_TOTAL_SCORE in bucket
  BUCKET_SUM_CREDIBILITY = sum of CREDIBILITY_WEIGHT in bucket
  BUCKET_WEIGHTED_SCORE = BUCKET_SUM_SCORE / max(BUCKET_SUM_CREDIBILITY, 1)
  BUCKET_N_FAILURES = count where ACCOMMODATION_OUTCOME = failure in bucket
  BUCKET_N_HEALTH_INCIDENTS = count where HEALTH_INCIDENT = true in bucket

Diet Pattern Analysis:
  BEST_DIET = diet bucket with highest WEIGHTED_SCORE (if any data)
  BEST_DIET_SCORE = WEIGHTED_SCORE of BEST_DIET
  WORST_DIET = diet bucket with lowest WEIGHTED_SCORE (if any data)
  WORST_DIET_SCORE = WEIGHTED_SCORE of WORST_DIET
  N_DIETS_WITH_ISSUES = count of diet buckets where N_FAILURES > 0 OR N_HEALTH_INCIDENTS > 0

  ACCOMMODATION_PATTERN:
    if N_DIETS_WITH_ISSUES >= 3: "systemic_issues" (problems across diets)
    elif BEST_DIET_SCORE - WORST_DIET_SCORE > 4.0: "highly_variable" (inconsistent)
    elif N_DIETS_WITH_ISSUES >= 1 AND WORST_DIET_SCORE < -2.0: "specific_weakness"
    elif all buckets have WEIGHTED_SCORE > 0: "generally_good"
    else: "mixed"

============================================================
L2: Aggregates (restaurant-level)
============================================================

Constants:
  BASE_SCORE = 5.0

Counts:
  N_DIETARY_REVIEWS = count of reviews where is_dietary_related = true
  N_SUCCESS = count where ACCOMMODATION_OUTCOME = success AND ACCOUNT_TYPE = firsthand
  N_FAILURE = count where ACCOMMODATION_OUTCOME = failure AND ACCOUNT_TYPE = firsthand
  N_HEALTH_INCIDENTS = count where HEALTH_INCIDENT = true
  N_UNINFORMED_FAILURES = count where UNINFORMED_FAILURE < 0

Confidence Level:
  if N_DIETARY_REVIEWS == 0: none
  elif N_DIETARY_REVIEWS <= 2: low
  elif N_DIETARY_REVIEWS <= 5: medium
  else: high

L1.5 Diet Aggregation:
  TOTAL_DIET_SCORE = sum of BUCKET_WEIGHTED_SCORE across all diet buckets
  N_DIET_BUCKETS_ACTIVE = count of buckets where N_REVIEWS > 0
  MEAN_DIET_SCORE = TOTAL_DIET_SCORE / max(N_DIET_BUCKETS_ACTIVE, 1)

============================================================
Formulas & Decision Policy
============================================================

Formulas:
  Pattern Multiplier (based on accommodation pattern):
    if ACCOMMODATION_PATTERN = "systemic_issues": PATTERN_MULT = 0.7
    elif ACCOMMODATION_PATTERN = "highly_variable": PATTERN_MULT = 0.85
    elif ACCOMMODATION_PATTERN = "specific_weakness": PATTERN_MULT = 0.9
    elif ACCOMMODATION_PATTERN = "generally_good": PATTERN_MULT = 1.1
    else: PATTERN_MULT = 1.0

  ADJUSTED_SCORE = MEAN_DIET_SCORE * PATTERN_MULT
  RAW_SCORE = BASE_SCORE + ADJUSTED_SCORE
  FINAL_SCORE = clamp(RAW_SCORE, 0.0, 10.0)

Decision Thresholds on FINAL_SCORE:
  - >= 7.0 => Excellent (highly accommodating)
  - >= 5.0 AND < 7.0 => Adequate (can accommodate with limitations)
  - >= 3.0 AND < 5.0 => Poor (struggles to accommodate)
  - < 3.0 => Very Poor (not recommended for dietary restrictions)

Overrides:
  - If N_HEALTH_INCIDENTS >= 1 => Very Poor (health risk)
  - If ACCOMMODATION_PATTERN = "systemic_issues" AND N_FAILURE >= 2 => Very Poor
  - If N_UNINFORMED_FAILURES >= 2 => max Poor (staff training issue)
  - If ACCOMMODATION_PATTERN = "generally_good" AND N_SUCCESS >= 5 => min Adequate
  - If ACCOMMODATION_PATTERN = "specific_weakness" => include diet warning in verdict

============================================================
Output Schema
============================================================

{
  L0_primitives: [ ... one record per dietary-related review ... ],
  L1_composites: [
    {
      review_id,
      diet_type,
      credibility_weight,
      outcome_score,
      staff_modifier,
      menu_modifier,
      consequence_penalty,
      l1_review_score,
      uninformed_failure,
      health_incident,
      l1_total_score
    },
    ...
  ],
  L1_5_diet_buckets: {
    vegetarian: { n_reviews, sum_score, sum_credibility, weighted_score, n_failures, n_health_incidents },
    vegan: { n_reviews, sum_score, sum_credibility, weighted_score, n_failures, n_health_incidents },
    gluten_free: { n_reviews, sum_score, sum_credibility, weighted_score, n_failures, n_health_incidents },
    other: { n_reviews, sum_score, sum_credibility, weighted_score, n_failures, n_health_incidents },
    best_diet,
    best_diet_score,
    worst_diet,
    worst_diet_score,
    n_diets_with_issues,
    accommodation_pattern
  },
  L2_aggregates: {
    N_DIETARY_REVIEWS,
    CONFIDENCE_LEVEL,
    N_SUCCESS, N_FAILURE,
    N_HEALTH_INCIDENTS,
    N_UNINFORMED_FAILURES,
    TOTAL_DIET_SCORE,
    MEAN_DIET_SCORE,
    PATTERN_MULT,
    BASE_SCORE,
    ADJUSTED_SCORE,
    RAW_SCORE,
    FINAL_SCORE
  },
  DecisionPolicy: {
    base_verdict_by_score,
    override_applied,
    VERDICT,
    diet_warning (if applicable)
  },
  decision_evidence: {
    high_score_reviews: [ {review_id, diet_type, l1_total_score, quote}, ... ],
    low_score_reviews: [ {review_id, diet_type, l1_total_score, quote}, ... ],
    health_incidents: [ {review_id, diet_type, consequence, quote}, ... ],
    diet_evidence: {
      best_diet,
      best_diet_score,
      worst_diet,
      worst_diet_score,
      accommodation_pattern
    }
  }
}
