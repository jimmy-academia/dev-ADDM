============================================================
Agenda
============================================================

Help assess customer loyalty and retention indicators for this restaurant.

Analyze each review to identify mentions of return visits, recommendations, and loyalty behaviors.
For each record, extract the L0 primitives defined below.

This task adds L1.5 loyalty-type grouping to identify what drives customer retention.

============================================================
L0: Primitives (per-review extraction)
============================================================

RETURN_INTENTION
- definitely_returning: explicitly states will return
- likely_returning: implies they'll come back
- uncertain: might or might not return
- unlikely_returning: probably won't return
- never_returning: explicitly states won't return
- not_mentioned: return intention not discussed

RECOMMENDATION_LIKELIHOOD
- highly_recommend: enthusiastically recommends
- recommend: would recommend
- conditional_recommend: recommends with caveats
- neutral: neither recommends nor discourages
- discourage: would not recommend
- strongly_discourage: actively warns others away
- not_mentioned: recommendation not discussed

VISIT_FREQUENCY
- regular: comes frequently
- occasional: visits sometimes
- rare: seldom visits
- first_time: first visit
- not_mentioned: frequency not discussed

RELATIONSHIP_DEPTH
- personal_connection: knows staff by name, feels connection
- recognized: staff recognizes them
- familiar: comfortable regular experience
- anonymous: just another customer
- not_mentioned: relationship not discussed

ADVOCACY_BEHAVIOR
- brings_others: actively brings friends/family
- shares_socially: shares on social media
- defends: defends restaurant to critics
- passive: enjoys but doesn't promote
- not_mentioned: advocacy not discussed

LOYALTY_TRIGGER
- food: loyal because of food
- service: loyal because of service
- atmosphere: loyal because of atmosphere
- value: loyal because of value
- convenience: loyal because of convenience
- habit: loyal out of habit
- multiple: loyal for multiple reasons
- not_mentioned: trigger not identified

============================================================
L1: Composites (derived per review)
============================================================

POSITIVE_LOYALTY = true iff ANY:
  - RETURN_INTENTION in {definitely_returning, likely_returning}
  - RECOMMENDATION_LIKELIHOOD in {highly_recommend, recommend}
  - VISIT_FREQUENCY = regular
  - ADVOCACY_BEHAVIOR in {brings_others, shares_socially, defends}
Else POSITIVE_LOYALTY = false

NEGATIVE_LOYALTY = true iff ANY:
  - RETURN_INTENTION in {unlikely_returning, never_returning}
  - RECOMMENDATION_LIKELIHOOD in {discourage, strongly_discourage}
Else NEGATIVE_LOYALTY = false

============================================================
L1.5: Loyalty Type Grouping
============================================================

Group reviews by loyalty type:
  BEHAVIORAL_LOYALTY = visit_frequency, return_intention (action-based)
  EMOTIONAL_LOYALTY = relationship_depth, loyalty_trigger (feeling-based)
  ADVOCACY_LOYALTY = recommendation_likelihood, advocacy_behavior (promotion-based)

For each loyalty bucket, compute:
  BUCKET_N_REVIEWS = count of reviews in this bucket
  BUCKET_N_STRONG = count with strong loyalty indicators
    (BEHAVIORAL: regular + definitely_returning)
    (EMOTIONAL: personal_connection + multiple triggers)
    (ADVOCACY: highly_recommend + brings_others/shares_socially)
  BUCKET_N_WEAK = count with weak/negative indicators
  BUCKET_LOYALTY_RATE = BUCKET_N_STRONG / max(BUCKET_N_REVIEWS, 1)

Loyalty Pattern Analysis:
  STRONGEST_TYPE = bucket with highest LOYALTY_RATE
  WEAKEST_TYPE = bucket with lowest LOYALTY_RATE
  N_TYPES_STRONG = count of buckets where LOYALTY_RATE >= 0.6

  LOYALTY_PATTERN:
    if N_TYPES_STRONG >= 3: "true_loyalty"
    elif BEHAVIORAL_LOYALTY LOYALTY_RATE >= 0.7: "habitual_loyalty"
    elif EMOTIONAL_LOYALTY LOYALTY_RATE >= 0.7: "emotional_attachment"
    elif ADVOCACY_LOYALTY LOYALTY_RATE >= 0.7: "brand_ambassador"
    elif N_TYPES_STRONG >= 1: "partial_loyalty"
    elif all types have LOYALTY_RATE < 0.3: "at_risk"
    else: "transactional"

============================================================
L2: Aggregates (restaurant-level)
============================================================

Constants:
  BASE_SCORE = 5.0

Counts:
  N_LOYALTY_REVIEWS = count of reviews with any loyalty-related primitives
  N_POSITIVE = count where POSITIVE_LOYALTY = true
  N_NEGATIVE = count where NEGATIVE_LOYALTY = true

Confidence Level:
  if N_LOYALTY_REVIEWS == 0: none
  elif N_LOYALTY_REVIEWS <= 2: low
  elif N_LOYALTY_REVIEWS <= 5: medium
  else: high

L1.5 Type Analysis:
  STRONGEST_TYPE
  STRONGEST_RATE
  WEAKEST_TYPE
  LOYALTY_PATTERN

============================================================
Formulas & Decision Policy
============================================================

Formulas (extends G6i with L1.5 loyalty pattern bonus):
  LOYALTY_RATE = N_POSITIVE / max(N_POSITIVE + N_NEGATIVE, 1)

  POSITIVE_SCORE = N_POSITIVE * 1.5
  NEGATIVE_SCORE = N_NEGATIVE * 1.5

  # L1.5 Loyalty Pattern Bonus (NEW in G6j)
  LOYALTY_PATTERN_BONUS:
    if LOYALTY_PATTERN = "true_loyalty": +2.0
    elif LOYALTY_PATTERN = "habitual_loyalty": +1.5
    elif LOYALTY_PATTERN = "emotional_attachment": +1.5
    elif LOYALTY_PATTERN = "brand_ambassador": +1.5
    elif LOYALTY_PATTERN = "partial_loyalty": +0.5
    elif LOYALTY_PATTERN = "at_risk": -1.5
    else: -1.0

  RAW_SCORE = BASE_SCORE + POSITIVE_SCORE - NEGATIVE_SCORE + LOYALTY_PATTERN_BONUS
  FINAL_SCORE = clamp(RAW_SCORE, 0.0, 10.0)

Decision Thresholds on FINAL_SCORE:
  - >= 7.5 => High Loyalty
  - >= 5.5 AND < 7.5 => Good Loyalty
  - >= 3.5 AND < 5.5 => Moderate Loyalty
  - < 3.5 => Low Loyalty

Overrides:
  - If LOYALTY_PATTERN = "true_loyalty" => min Good Loyalty
  - If LOYALTY_PATTERN = "at_risk" => max Moderate Loyalty
  - Include strength note based on LOYALTY_PATTERN
  - Include development note based on WEAKEST_TYPE if rate < 0.4

============================================================
Output Schema
============================================================

{
  L0_primitives: [ ... one record per loyalty-related review ... ],
  L1_composites: [ ... one record per loyalty-related review ... ],
  L1_5_type_buckets: {
    behavioral: { n_reviews, n_strong, n_weak, loyalty_rate },
    emotional: { n_reviews, n_strong, n_weak, loyalty_rate },
    advocacy: { n_reviews, n_strong, n_weak, loyalty_rate },
    strongest_type,
    strongest_rate,
    weakest_type,
    n_types_strong,
    loyalty_pattern
  },
  L2_aggregates: {
    N_LOYALTY_REVIEWS,
    CONFIDENCE_LEVEL,
    N_POSITIVE, N_NEGATIVE,
    LOYALTY_RATE,
    POSITIVE_SCORE,
    NEGATIVE_SCORE,
    BASE_SCORE,
    RAW_SCORE,
    FINAL_SCORE
  },
  DecisionPolicy: {
    base_verdict_by_score,
    override_applied,
    VERDICT,
    strength_note (if applicable),
    development_note (if applicable)
  },
  decision_evidence: {
    loyal_customer_mentions: [ {review_id, type, quote}, ... ],
    disloyal_customer_mentions: [ {review_id, type, quote}, ... ],
    type_evidence: {
      strongest_type,
      weakest_type,
      loyalty_pattern
    }
  }
}
